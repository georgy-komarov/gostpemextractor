# Gost PEM Extractor

Основано на [Privkey2012](https://github.com/iliadmitriev/privkey2012)

## Требования для работы

При экспорте из ViPNet CSP достаточно PFX с включенным в него приватным ключом.

При экспорте из КриптоПро CSP нужен PFX (не обязательно с ключом) и ключ (хранилище).

Хранилище это директория с файлами:
```
header.key
masks.key
masks2.key
name.key
primary.key
primary2.key
```

### Для экспорта из ViPNet CSP:
1. В окне «ViPNet CSP» в разделе «Контейнеры ключей» выберите контейнер ключей, содержащий сертификат или сертификат и закрытый ключ, которые вы хотите экспортировать. Нажмите кнопку «Свойства» либо дважды щелкните нужный контейнер ключей.
2. В окне «Свойства контейнера ключей» нажмите кнопку «Открыть».
3. В окне «Сертификат» перейдите на вкладку «Состав» и нажмите кнопку «Копировать в файл».
4. На странице приветствия мастера экспорта сертификатов нажмите кнопку «Далее».
5. На странице «Экспортирование закрытого ключа» укажите, что хотите вместе с сертификатом экспортировать закрытый ключ.
6. На странице «Формат экспортируемого файла» выберите формат PKCS #12 (.PFX).
7. На странице «Пароль» задайте и подтвердите пароль доступа к экспортируемому закрытому ключу.
8. На странице «Имя файла экспорта» укажите директорию, в которой вы хотите создать файл с экспортируемыми ключами, и задайте имя этого файла.
9. На странице завершения работы мастера экспорта сертификатов нажмите кнопку «Готово».

### Для экспорта из КриптоПро CSP:
1. Перейти в Панель управления (ПУСК – Панель управления) найти и запустить "Инструменты КриптоПро" (присутствует в версии 5).
2. На вкладке "Сертификаты" выбрать нужный сертификат.
3. Нажать "Экспортировать ключи" (экспортирование только сертификата в .cer работает почему-то некорректно)
4. В поле "Введите пароль на PFX" ввести пароль от контейнера (в скрипте захардкожено, что пароли от контейнера КриптоПро и PFX должны быть одинаковыми)
5. Указать путь для сохранения файла сертификата.
6. На вкладке "Контейнеры" выбрать нужный контейнер.
7. Выбрать нужный контейнер и нажать «Скопировать контейнер» и следуя мастеру, скопировать ключ на съемный носитель (или на системный диск, см. `C:\Users\User\AppData\Local\Crypto Pro`).

## Сборка

```
docker build -t gostpemextractor ./
```

## Запуск

Файл certificate.pfx и директория storage.001 находятся в текущей директории. При успехе в текущей директории создаются два файла certificate.crt.pem и certificate.key.pem
Пример при наличии pfx файла и хранилища закрытого ключа:
```
docker run --rm -ti -v `pwd`:/work gostpemextractor -f certificate.pfx -p password -s storage.001
```
Пример при наличии только pfx файла с включенным в него приватным ключом:
```
docker run --rm -ti -v `pwd`:/work gostpemextractor -f certificate.pfx -p password 
```
Пример команды для Windows:
```
docker run --rm -ti -v C:\temp\cert\1231:/work gostpemextractor -f certificate.pfx -p password -s storage.001
```
Запуск bash в контейнере (полезно для дебага):
```
docker run --rm -ti --entrypoint bash -v `pwd`:/work gostpemextractor
```

При указании параметра `-l [256|512]` (длина хэш-кода, см. поле "Хэш-алгоритм подписи в certmgr.msc"), будет создан контейнер PKCS#12.  
Данный контейнер будет совместим с VipNet CSP. Пароль - тот же, который задан параметром `-p`
